{% extends 'GoproSonataBundle:Admin:edit.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <style type="text/css">
        tr.row-dietacomidas td.campo-numerocomida{background-color: palegreen}
        tr.row-dietaalimentos td.campo-cantidad{background-color: lightblue}
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script type="text/javascript">
        (function ($) {

            $.fn.cambiovalor = function () {

                var methods = {
                    init: function () {
                        var $this = $(this);
                        $this.off("change", methods.seleccionar).on("change", methods.seleccionar);
                        $this.off("input", methods.seleccionar).on("input", methods.seleccionar);

                        return $this;
                    },
                    seleccionar: function (event) {

                        var alimentoregex = /dietacomidas_\d*_dietaalimentos_\d*_alimento_autocomplete_input_v4$/g;
                        var cantidadregex = /dietacomidas_\d*_dietaalimentos_\d*_cantidad$/g;

                        if(alimentoregex.test($(this).attr("id")) === true) {
                            return methods.procesaralimento.call(this, event);
                        }
                        if(cantidadregex.test($(this).attr("id")) === true) {
                            return methods.procesarcantidad.call(this, event);
                        }
                    },
                    procesarcantidad: function (event) {

                        var baseId = $(this).attr("id").replace(/cantidad$/g, '');
                        var alimentoId = baseId + 'alimento_autocomplete_input_v4';
                        var inputval = $('select#' + alimentoId).val();
                        if(!$.isNumeric(inputval)){
                            return $this;
                        }

                        var cantidadId = $(this).attr("id");
                        var cantidad = $(this).val();

                        if(!$.isNumeric(cantidad)){
                            return;
                            //$(this).val(1)
                            //cantidad = 1;
                        }

                        var grasaId = baseId + 'grasa';
                        var carbohidratoId = baseId + 'carbohidrato';
                        var proteinaId = baseId + 'proteina';

                        return methods.completarvalores.call(this, baseId, cantidad, $('input#' + cantidadId).attr('data-medidaalimento'), $('input#' + cantidadId).attr('data-cantidadalimento'), $('input#' + grasaId).val(), $('input#' + carbohidratoId).val(), $('input#' + proteinaId).val(), $('input#' + cantidadId).attr('data-proteinaaltovalor'), $('input#' + cantidadId).data('tipoalimento'));

                    },
                    procesaralimento: function (event) {

                        var baseId = $(this).attr("id").replace(/alimento_autocomplete_input_v4$/g, '');
                        var alimentoId = $(this).attr("id");
                        var inputval = $('select#' + alimentoId).val();
                        if(!$.isNumeric(inputval)){
                            return $this;
                        }

                        var url = "{{ path(admin.vars.dietaalimentos.alimentopath) }}" + '/' + inputval;

                        return methods.makeajaxcall.call(this, event, url, baseId);

                    },
                    makeajaxcall: function (event, url, baseId) {
                        $.ajax({
                            url:  url,
                            context: $(this),
                            success: function(result){
                                var cantidadId = baseId + 'cantidad';
                                var cantidad = $('input#' + cantidadId).val();
                                //console.log(cantidad);
                                if(!$.isNumeric(cantidad)){
                                    $('input#' + cantidadId).val(1)
                                    cantidad = 1;
                                }

                                var grasaId = baseId + 'grasa';
                                var carbohidratoId = baseId + 'carbohidrato';
                                var proteinaId = baseId + 'proteina';

                                if(result.id) {

                                    var resultgrasa = parseFloat(result.grasa);
                                    var resultcarbohidrato = parseFloat(result.carbohidrato);
                                    var resultproteina = parseFloat(result.proteina);
                                    var resultcantidadalimento = parseFloat(result.cantidad);
                                    var resultmedidaalimento = result.medidaalimento;
                                    var resultproteinaaltovalor = result.proteinaaltovalor;
                                    var resultipoalimento = result.tipoalimento;

                                    $('input#' + cantidadId).attr('data-cantidadalimento', resultcantidadalimento).attr('data-medidaalimento', resultmedidaalimento).attr('data-tipoalimento', resultipoalimento).attr('data-proteinaaltovalor', resultproteinaaltovalor);

                                    $('input#' + grasaId).val(resultgrasa).trigger('input');
                                    $('input#' + carbohidratoId).val(resultcarbohidrato).trigger('input');
                                    $('input#' + proteinaId).val(resultproteina).trigger('input');

                                    return methods.completarvalores.call(this, baseId, cantidad, $('input#' + cantidadId).attr('data-medidaalimento'), $('input#' + cantidadId).attr('data-cantidadalimento'), $('input#' + grasaId).val(), $('input#' + carbohidratoId).val(), $('input#' + proteinaId).val(), $('input#' + cantidadId).attr('data-proteinaaltovalor'), $('input#' + cantidadId).data('tipoalimento'));
                                }

                            }}
                        );
                    },

                    completarvalores: function (baseId, cantidad, medidaalimento, cantidadalimento, grasa, carbohidrato, proteina, proteinaaltovalor, tipoalimento) {

                        var medidacantidadId = baseId + 'medidacantidad';
                        var grasaTotalId = baseId + 'grasatotal';
                        var carbohidratoTotalId = baseId +'carbohidratototal';
                        var proteinaTotalId = baseId + 'proteinatotal';
                        var proteinaTotalAltoId = baseId + 'proteinatotalalto';

                        var grasaCaloriasId = baseId + 'grasacalorias';
                        var carbohidratoCaloriasId = baseId + 'carbohidratocalorias';
                        var proteinaCaloriasId = baseId + 'proteinacalorias';

                        var totalCaloriasId = baseId + 'totalcalorias';
                        var energiaCaloriasId = baseId + 'energiacalorias';

                        cantidad = parseFloat(cantidad);
                        cantidadalimento = parseFloat(cantidadalimento);
                        grasa = parseFloat(grasa);
                        carbohidrato = parseFloat(carbohidrato);
                        proteina = parseFloat(proteina);

                        $('input#' + medidacantidadId).val(cantidadalimento * cantidad + ' ' + medidaalimento).trigger('input');
                        $('input#' + grasaTotalId).val((grasa * cantidad).toFixed(2)).trigger('input');
                        $('input#' + carbohidratoTotalId).val((carbohidrato * cantidad).toFixed(2)).trigger('input');
                        $('input#' + proteinaTotalId).val((proteina * cantidad).toFixed(2)).trigger('input');

                        if(proteinaaltovalor === 'true'){
                            $('input#' + proteinaTotalAltoId).val((proteina * cantidad).toFixed(2)).trigger('input');
                        }else{
                            $('input#' + proteinaTotalAltoId).val(parseFloat(0).toFixed(2)).trigger('input')
                        }

                        $('input#' + grasaCaloriasId).val((grasa * cantidad * 9).toFixed(2)).trigger('input');
                        $('input#' + carbohidratoCaloriasId).val((carbohidrato * cantidad * 4).toFixed(2)).trigger('input');
                        $('input#' + proteinaCaloriasId).val((proteina * cantidad * 4).toFixed(2)).trigger('input');

                        $('input#' + totalCaloriasId).val(((grasa * 9 + carbohidrato * 4 + proteina * 4) * cantidad).toFixed(2)).trigger('input');
                        $('input#' + energiaCaloriasId).val(((grasa * 9 + carbohidrato * 4) * cantidad).toFixed(2)).trigger('input');

                        hacerresumen.resumenDietaalimentos();
                        hacerresumen.resumenDietacomidas();
                    }
                };

                return $(this).each(function (i, element) {
                    methods.init.apply($(element));
                });
            };

        })(jQuery);

        var hacerresumen = {
            resumenDietaalimentos: function () {
                $('.campo-dietaalimentos').each(function(){

                    var baseIdDietaalimentos = $(this).children(":first").attr('id').replace('field_container_','');

                    var contenedor = $(this);

                    $.each(['grasatotal', 'carbohidratototal', 'proteinatotal', 'proteinatotalalto', 'grasacalorias', 'carbohidratocalorias', 'proteinacalorias', 'totalcalorias', 'energiacalorias'], function( index, value ) {

                        var cantidad = 0;
                        contenedor.find('.campo_' + value).each(function(){
                            cantidad = cantidad + parseFloat($(this).val());
                        });

                        $('#' + baseIdDietaalimentos + '_resumen_' + value ).val(cantidad);

                    });

                    $.each(['grasacalorias', 'carbohidratocalorias', 'proteinacalorias'], function( index, value ) {
                        var resultado = parseFloat($('#' + baseIdDietaalimentos + '_resumen_' + value).val()) / parseFloat($('#' + baseIdDietaalimentos + '_resumen_totalcalorias').val()) * 100;
                        $('#' + baseIdDietaalimentos + '_resumen_' + value + 'porcentaje' ).val(resultado.toFixed(2));
                    });

                });
            },
            resumenDietacomidas: function () {

                var baseIdDietacomidas = $('.field-container-dietacomidas').attr('id').replace('field_container_','');

                $.each(['grasatotal', 'carbohidratototal', 'proteinatotal', 'proteinatotalalto', 'grasacalorias', 'carbohidratocalorias', 'proteinacalorias', 'totalcalorias', 'energiacalorias'], function( index, value ) {

                    var cantidad = 0;
                    $('.resumen_' + value).each(function(){
                        cantidad = cantidad + parseFloat($(this).val());
                    });

                    $('#' + baseIdDietacomidas + '_total_' + value ).val(cantidad);

                });

                $.each(['grasacalorias', 'carbohidratocalorias', 'proteinacalorias'], function( index, value ) {
                    var resultado = parseFloat($('#' + baseIdDietacomidas + '_total_' + value).val()) / parseFloat($('#' + baseIdDietacomidas + '_total_totalcalorias').val()) * 100;
                    $('#' + baseIdDietacomidas + '_total_' + value + 'porcentaje' ).val(resultado.toFixed(2));
                });
            }

        };

        $(document).ready(function(){
            $('select').cambiovalor();
            $('.campo-cantidad input').cambiovalor();

            hacerresumen.resumenDietaalimentos();
            hacerresumen.resumenDietacomidas();

            $('.table').off('table:rowdeleted').on('table:rowdeleted', function() {
                hacerresumen.resumenDietaalimentos();
                hacerresumen.resumenDietacomidas();
            });

            $('body').on('sonata.add_element', function() {
                $('select').cambiovalor();
                $('.campo-cantidad input').cambiovalor();

                $('.table').off('table:rowdeleted').on('table:rowdeleted', function() {
                    hacerresumen.resumenDietaalimentos();
                    hacerresumen.resumenDietacomidas();
                });

            });

        });

    </script>
{% endblock %}
